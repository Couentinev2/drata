ARCHITECTURAL DECISIONS
=====================


TECHNOLOGY STACK
----------------


Next.js 16 (App Router)
- Server-side rendering and static generation
- React Server Components for reduced client JS
- Built-in API routes and image optimization

Builder.io
- Visual page builder for non-technical users
- Component-based architecture
- API-driven content delivery

Tailwind CSS
- Utility-first styling
- Fast development and small bundle size


ARCHITECTURE PATTERNS
--------------------


Hybrid Rendering

SSR (default)
- Server fetches Builder.io content
- Renders HTML on the server

CSR (editor/preview mode)
- Client component (BuilderPreviewClient)
- Polls Builder.io API every 1.2 seconds for live updates


Component Registration
- Custom React components registered with Builder.io
- Configurable props exposed through Builder.io inputs


API Route Pattern
- Chat functionality in `/api/chat` route
- Backend logic isolated from frontend UI


Streaming Responses
- Chat API uses ReadableStream
- Sends word-by-word responses to client


DATA FLOW
=========


Page Rendering

User Request → Next.js Server
  |
  |-- Check for Builder.io Editor/Preview Mode
  |     |
  |     |-- YES → BuilderPreviewClient (CSR)
  |     |           - Polls Builder.io API every 1.2s
  |     |
  |     |-- NO  → Server-Side Fetch
  |                - Cache check (5s revalidation)
  |                - Fetch via Builder.io SDK
  |                - Render Server Component


AI Chat Flow

User Message → AiAssistant Component
  |
  |-- POST /api/chat
  |
  |-- API Route Handler
  |     - Parse message
  |     - Keyword matching
  |     - Generate response
  |     - Stream via ReadableStream
  |
  |-- Client receives stream
        - Decode chunks
        - Update UI incrementally
        - Display message


Builder.io Content Delivery

Builder.io Cloud
  |
  |-- Next.js Server (SSR)
  |     - Cache layer (5s revalidation)
  |     - Render to HTML
  |
  |-- Browser
        - Hydrate React Components


CACHING STRATEGY
================


Multi-Layer Caching

1) Next.js ISR (Incremental Static Regeneration)
   Location: app/[[...page]]/page.tsx
   Configuration: export const revalidate = 5

   - Pages statically generated
   - Revalidated every 5 seconds
   - Benefits:
       * Fast CDN responses
       * Fresh content
       * Reduced API calls

2) Builder.io SDK Caching
   - Built-in caching in SDK
   - Cache invalidated when:
       * builder.preview query param present
       * builder.editor query param present
       * builder.noCache or builder.cachebust present

3) Browser Caching
   - Next.js sets appropriate cache headers
   - Static assets cached long-term
   - HTML respects revalidation strategy

4) CDN Caching (Vercel)
   - Edge network caching
   - Global distribution
   - Auto-invalidated on deployments


Cache Invalidation


Automatic:
- On deployment (Vercel clears cache)
- After 5-second revalidation window

Manual:
- Builder.io webhook integration (invalidate on content updates)
- Vercel API for programmatic cache clearing

Editor / Preview Mode:
- Bypasses all caches
- Uses:
    * cachebust: true
    * includeUnpublished: true
